<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dq.aquaranth.menu.mapper.MenuMapper">

    <sql id="find_all">
        <where>
            <if test="menu.menuCode != null">
                OR tm.menu_code = #{menu.menuCode}
            </if>
            <if test="menu.menuNo != null">
                OR tm.menu_no = #{menu.menuNo}
            </if>
            <if test="menu.keyword eq 'gnb'">
                OR tm.upper_menu_no IS NULL
            </if>
            <if test="menu.keyword eq 'lnb'">
                OR MATCH (tm.menu_path) AGAINST ( '%/'#{menu.menuCode}'/%' )
            </if>
        </where>
    </sql>

    <sql id="find_one">
        <where>
            <if test="menu.menuCode != null">
                AND tm.menu_code = #{menu.menuCode}
            </if>
            <if test="menu.menuNo != null">
                AND tm.menu_no = #{menu.menuNo}
            </if>
        </where>
    </sql>

    <select id="findBy" resultType="com.dq.aquaranth.menu.dto.response.MenuResponseDTO">
        select distinct tm.*
        from (
        select orga.orga_no, orga_role_no, role_group_no
        from (
        with recursive cte as (
        select o.*
        from tbl_orga o
        join tbl_dept_mapping tdm on o.orga_no = tdm.orga_no
        where tdm.dept_no = #{user.deptNo}
        union all
        select t.*
        from cte c
        join tbl_orga t on t.orga_no = c.upper_orga_no
        )
        select orga_no
        from tbl_company
        where company_no = #{user.companyNo}
        union
        select orga_no
        from cte
        union
        select to2.orga_no
        from tbl_emp te
        join tbl_emp_mapping tem on te.emp_no = tem.emp_no
        join tbl_orga to2 on tem.orga_no = to2.orga_no
        join tbl_dept_mapping m on to2.upper_orga_no = m.orga_no
        where te.username = #{user.username}
        and m.dept_no = #{user.deptNo}
        ) orga
        left join tbl_orga_role tor on tor.orga_no = orga.orga_no
        ) ogr
        join tbl_role_group trg on trg.role_group_no = ogr.role_group_no
        join tbl_menu_role tmr on trg.role_group_no = tmr.role_group_no
        join tbl_menu tm on tmr.menu_no = tm.menu_no
        <include refid="find_one"/>
        order by menu_path
    </select>

    <select id="findAllBy" resultType="com.dq.aquaranth.menu.dto.response.MenuResponseDTO">
        select distinct tm.*
        from (
        select orga.orga_no, orga_role_no, role_group_no
        from (
        with recursive cte as (
        select o.*
        from tbl_orga o
        join tbl_dept_mapping tdm on o.orga_no = tdm.orga_no
        where tdm.dept_no = #{user.deptNo}
        union all
        select t.*
        from cte c
        join tbl_orga t on t.orga_no = c.upper_orga_no
        )
        select orga_no
        from tbl_company
        where company_no = #{user.companyNo}
        union
        select orga_no
        from cte
        union
        select to2.orga_no
        from tbl_emp te
        join tbl_emp_mapping tem on te.emp_no = tem.emp_no
        join tbl_orga to2 on tem.orga_no = to2.orga_no
        join tbl_dept_mapping m on to2.upper_orga_no = m.orga_no
        where te.username = #{user.username}
        and m.dept_no = #{user.deptNo}
        ) orga
        left join tbl_orga_role tor on tor.orga_no = orga.orga_no
        ) ogr
        join tbl_role_group trg on trg.role_group_no = ogr.role_group_no
        join tbl_menu_role tmr on trg.role_group_no = tmr.role_group_no
        join tbl_menu tm on tmr.menu_no = tm.menu_no
        <include refid="find_all"/>
        order by menu_path
    </select>
</mapper>
